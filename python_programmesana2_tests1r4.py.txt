# ğŸ§ª Python KodÄ“Å¡ana 2 â€“ Tests (1.â€“4. nodarbÄ«ba)

import ipywidgets as widgets
from IPython.display import display, clear_output
import random
from datetime import datetime
import os
import requests

# JautÄjumu saraksts
questions_data = [
    ("Ko dara pygame.init()?", [
        "InicializÄ“ visus importÄ“tos pygame moduÄ¼us",
        "PalaiÅ¾ spÄ“les ciklu",
        "IelÄdÄ“ spÄ“les logu",
        "Izveido galveno varoÅ†a sprite objektu"
    ], 0),
    ("Kura metode tiek izmantota, lai uzzÄ«mÄ“tu taisnstÅ«ri pygame logÄ?", [
        "pygame.draw.rect()",
        "pygame.screen.rectangle()",
        "pygame.create.rect()",
        "pygame.render.rect()"
    ], 0),
    ("KÄ tiek atjauninÄts logs pygame pÄ“c zÄ«mÄ“Å¡anas?", [
        "pygame.display.flip()",
        "pygame.update.display()",
        "pygame.screen.refresh()",
        "pygame.render.frame()"
    ], 0),
    ("Ko pÄrbauda event.type == pygame.QUIT?", [
        "Vai lietotÄjs ir nospiedis loga aizvÄ“rÅ¡anas pogu",
        "Vai lietotÄjs nospieda taustiÅ†u Enter",
        "Vai spÄ“lei jÄsÄkas no jauna",
        "Vai spÄ“lÄ“tÄjs zaudÄ“ja"
    ], 0),
    ("KurÅ¡ modulis tiek izmantots, lai veidotu GUI lietotnes Python valodÄ?", [
        "tkinter",
        "pygame.gui",
        "guimodule",
        "tkbuilder"
    ], 0),
    ("KurÅ¡ tkinter logelements tiek izmantots, lai saÅ†emtu tekstu no lietotÄja?", [
        "Entry",
        "Label",
        "Button",
        "Canvas"
    ], 0),
    ("Ko dara mainloop() tkinter lietotnÄ“?", [
        "PalaiÅ¾ GUI notikumu ciklu",
        "PieslÄ“dzas datubÄzei",
        "Atjauno Python vidi",
        "Izveido loga izvietojumu"
    ], 0),
    ("KurÅ¡ tkinter logelements Ä¼auj zÄ«mÄ“t figÅ«ras kÄ taisnstÅ«rus un tekstu?", [
        "Canvas",
        "Frame",
        "Box",
        "Entry"
    ], 0),
]

random.shuffle(questions_data)
results = [None] * len(questions_data)
attempts = [0] * len(questions_data)
question_widgets = []
submit_button = widgets.Button(description="Iesniegt rezultÄtu", button_style='success')
download_button = widgets.Button(description="â¬‡ï¸ LejupielÄdÄ“t rezultÄtu", button_style='info')
name_input = widgets.Text(description='VÄrds:', placeholder='Ievadi savu vÄrdu')

# Google Forms konfigurÄcija
form_url = "https://docs.google.com/forms/d/e/1FAIpQLSdTSrnEP9GQajJRRCKqQMbwWGS_TL3o3B4T_fequkWmUZQCCg/formResponse"
entry_ids = {
    "Students": "entry.1649720525",
    "Datums": "entry.667959859",
    "Rezultats": "entry.940605140"
}

def create_question(index, question, options, correct_index):
    out = widgets.Output()
    paired = list(enumerate(options))
    random.shuffle(paired)
    shuffled_indexes, shuffled_options = zip(*paired)
    correct_shuffled_index = shuffled_indexes.index(correct_index)

    radio = widgets.RadioButtons(options=shuffled_options)
    button = widgets.Button(description='PÄrbaudÄ«t')
    feedback = widgets.HTML()

    def on_click(b):
        attempts[index] += 1
        if radio.index == correct_shuffled_index:
            penalty = 5 * (attempts[index] - 1)
            score = max(12.5 - penalty, 0)
            results[index] = score
            feedback.value = "<span style='color:green'>âœ”ï¸ Pareizi!</span>"
            radio.disabled = True
            button.disabled = True
            if all(r is not None for r in results):
                display(widgets.VBox([name_input, submit_button]))
        else:
            feedback.value = "<span style='color:red'>âŒ Nepareizi. MÄ“Ä£ini vÄ“lreiz.</span>"

    button.on_click(on_click)

    with out:
        display(widgets.HTML(f"<b>{index+1}. {question}</b>"), radio, button, feedback)
    return out

def calculate_score(_):
    clear_output()
    for w in question_widgets:
        display(w)
    total = sum(r if r else 0 for r in results)
    final_score = round(total)
    status = "âœ… NokÄrtots!" if final_score >= 70 else "âŒ NenokÄrtots."
    color = "green" if final_score >= 70 else "red"
    display(widgets.HTML(f"<h3>RezultÄts: <span style='color:{color}'>{final_score}%</span> â€“ {status}</h3>"))
    display(download_button)

    # NosÅ«tÄ«Å¡ana uz Google Forms
    student_name = name_input.value.strip() or "NezinÄms"
    now = datetime.now().strftime("%Y-%m-%d %H:%M")
    form_data = {
        entry_ids["Students"]: student_name,
        entry_ids["Datums"]: now,
        entry_ids["Rezultats"]: str(final_score)
    }
    try:
        requests.post(form_url, data=form_data)
    except:
        display(widgets.HTML("<b style='color:red'>NeizdevÄs nosÅ«tÄ«t uz Google Formu.</b>"))

def download_result(_):
    student_name = name_input.value.strip() or "NezinÄms"
    total = sum(r if r else 0 for r in results)
    final_score = round(total)
    now = datetime.now().strftime("%Y-%m-%d %H:%M")
    filename = f"rezultats_{student_name.replace(' ', '_')}.txt"

    with open(filename, 'w', encoding='utf-8') as f:
        f.write(f"Students: {student_name}\nDatums: {now}\nRezultÄts: {final_score}%\n\n")
        for i, (q, _, _) in enumerate(questions_data):
            f.write(f"{i+1}. {q} (MÄ“Ä£inÄjumi: {attempts[i]})\n")

    from google.colab import files
    files.download(filename)

submit_button.on_click(calculate_score)
download_button.on_click(download_result)

# ParÄda visus jautÄjumus
for i, (q, opts, correct) in enumerate(questions_data):
    qw = create_question(i, q, opts, correct)
    question_widgets.append(qw)
    display(qw)
